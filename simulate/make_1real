#!/bin/bash
ireal=$1
nthread=8
amp=5e-14

. ./settings

rm -rf real.$ireal
mkdir real.$ireal
cd real.$ireal
cp ../*.par .
ln -s ../*.ideal .
ln -s ../*.add* .

echo -ne "REAL $ireal\r"
for i in *.par ; do
   while [[ `jobs -r | wc -l` -ge $nthread ]] ; do
	  n=`jobs -r | wc -l`
	  echo -ne "Wait ($n/$nthread) running" `date +%T` `cat /proc/loadavg` "    \r"
	  sleep 0.05
   done

   psr=`basename $i .par`
   nobs=`wc -l $psr.ideal | awk '{print $1+1000}'`
   echo -ne "$ireal $psr \r"
   red=""
   if [[ -e $psr.ideal.addRedNoise ]] ; then
	  red="-corn $psr.ideal.addRedNoise $ireal"
   fi
   echo tempo2-mjk -gr createRealisation -f $psr.ideal -corn $psr.ideal.addGauss $ireal -corn $psr.ideal.addGWB $ireal $red -npsr 1 -nobs $nobs
   tempo2-mjk -gr createRealisation -f $psr.ideal -corn $psr.ideal.addGauss $ireal -corn $psr.ideal.addGWB $ireal $red -npsr 1 -nobs $nobs  > /dev/null && mv $psr.ideal.real $psr.tim &
   echo -n "-f $psr.par $psr.tim " >> many
done

wait

cp ../*.model .

exit

